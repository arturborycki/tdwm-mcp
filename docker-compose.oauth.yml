version: "3.8"

services:
  tdwm-mcp:
    build: .
    container_name: tdwm-mcp-oauth
    environment:
      - MCP_TRANSPORT=sse
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      - DATABASE_URI=teradatasql://username:password@hostname/database
      # Connection resilience settings
      - DB_MAX_RETRIES=3
      - DB_INITIAL_BACKOFF=1.0
      - DB_MAX_BACKOFF=30.0
      # OAuth 2.1 Configuration (ENABLED)
      - OAUTH_ENABLED=true
      - KEYCLOAK_URL=https://keycloak.example.com
      - KEYCLOAK_REALM=tdwm-realm
      - KEYCLOAK_CLIENT_ID=tdwm-mcp
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
      - OAUTH_RESOURCE_SERVER_URL=https://mcp.example.com
      - OAUTH_REQUIRED_SCOPES=tdwm:read,tdwm:monitor
      - OAUTH_VALIDATE_AUDIENCE=true
      - OAUTH_VALIDATE_SCOPES=true
      - OAUTH_REQUIRE_HTTPS=true
      # Optional OAuth endpoints override
      # - OAUTH_TOKEN_VALIDATION_ENDPOINT=https://keycloak.example.com/auth/realms/tdwm-realm/protocol/openid-connect/token/introspect
      # - OAUTH_JWKS_ENDPOINT=https://keycloak.example.com/auth/realms/tdwm-realm/protocol/openid-connect/certs
    ports:
      - "8000:8000"
    restart: unless-stopped
    networks:
      - tdwm-oauth

  # Optional: Include Keycloak for development/testing
  keycloak:
    image: quay.io/keycloak/keycloak:23.0.4
    container_name: keycloak-tdwm-dev
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_HTTP_PORT=8080
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
    ports:
      - "8080:8080"
    command: start-dev
    networks:
      - tdwm-oauth

networks:
  tdwm-oauth:
    driver: bridge